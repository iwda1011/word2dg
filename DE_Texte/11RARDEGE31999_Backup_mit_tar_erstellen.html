<!DOCTYPE html><html><head><meta charset="UTF-8"></head><body><p>Title:</p><p>Backup mit tar: So erstellen Sie Archive unter Linux</p><p>Description:</p><p>Vermeiden Sie Datenverlust mit regelmäßigen Sicherungen. Wir erklären Ihnen, wie Sie inkrementelle Backups mit tar erstellen.</p><p>Teaser</p><p>Regelmäßige Backups sind einer der wichtigsten Faktoren bei der IT-Sicherheit. Bei Linux-Systemen – die häufig das Rückgrat eines Webservers sind – können Sie sehr effizient Sicherungskopien mit dem Programm tar erstellen. Was kann das Archivierungsprogramm? Wir erklären Ihnen, wie tar funktioniert und was die Besonderheiten sind. Damit auch Sie künftig regelmäßig Backups mit tar erstellen können, erklären wir Ihnen Schritt für Schritt wie Sie ein Backup-Skript erzeugen.</p><p>__________________________________________________________________________________</p><h1><a id="template_header_end"></a>Backup mit tar erstellen: So funktioniert die Archivierung</h1><p>Das Archivierungsprogramm tar basiert auf einer alten Datensicherungsmethode, die aber auch heute noch überzeugt. Der Name tar ist eigentlich ein Akronym und steht für Tape Archiver, also die Archivierung auf Bandlaufwerken. Auch wenn zumindest Privatanwender diese heutzutage kaum noch benutzen, ist das Programm immer weiterhin das beliebteste Werkzeug zur Archivierung auf Unix-Systemen. Mit dem Packprogramm können auch regelmäßige, inkrementelle Backups eines Servers erstellt werden. Wir erklären Ihnen, wie tar funktioniert und mit welchen Befehlen die Datensicherung klappt. </p><p>_TABLE_OF_CONTENT_</p><h2>Wie funktioniert tar?</h2><p>tar ist ein Programm zur Archivierung unter Linux und verwandten Systemen. Für ein solches Programm untypisch bietet tar dabei standardmäßig keine Komprimierung an. Dennoch ist das Programm sehr populär, denn sein großer Vorteil liegt darin, dass <strong>ganze Verzeichnisse zu einer Datei zusammengeführt</strong> werden können. Diese Technik hängt mit der Geschichte des Programms zusammen: Bei einem Bandlaufwerk werden die Daten nacheinander auf ein Magnetband übertragen. Dies erklärt die sequenzielle, lineare Speicherung beim tar-Format. Neue Dateien werden hinten an das Archiv angehängt. Eine daraus entstehende Datei wird auch Tarball (englisch für Teerkugel) genannt, da die Dateien praktisch „aneinandergeklebt“ sind.</p><p>Um dennoch eine <strong>Komprimierung</strong> zu erreichen wird tar häufig in Kombination mit gzip verwendet. Die beiden Programme ergänzen sich dabei perfekt: gzip kann immer nur einzelne Dateien komprimieren. Deshalb wird in der Regel zunächst tar und dann gzip (oder auch ein anderes Programm zur Kompression) eingesetzt. So entstehen schließlich .tar.gz- oder .tzip-Dateien.</p><h3>tar installieren</h3><p>Unter Ubuntu sollte tar bereits vorinstalliert sein. Wenn Sie eine andere Linux- oder Unix-Distribution verwenden, installieren Sie das hilfreiche Programm mit:</p><p>	<em>sudo apt-get install tar tar-doc</em></p><p>Das Paket tar-doc ist dabei optional: Es enthält eine Dokumentation zum Archivierungsprogramm.</p><h3>tar benutzen</h3><p>Wenn Sie tar benutzen möchten, verwenden Sie einfach diese Syntax:</p><p>	<em>tar Option Datei</em></p><p>Die <strong>Optionen</strong> von tar sind folgende: </p><table><tr><td><p>Option</p></td><td><p>Beschreibung</p></td><td><p>Besonderheit</p></td></tr><tr><td><p>--help</p></td><td><p>Zeigt Ihnen alle Optionen an.</p></td><td></td></tr><tr><td><p>--version</p></td><td><p>Gibt die verwendete Version von tar aus.</p></td><td></td></tr><tr><td><p>-c</p></td><td><p>Erzeugt ein neues Archiv.</p></td><td><p>(<em>create</em>)</p></td></tr><tr><td><p>-d</p></td><td><p>Vergleicht Dateien im Archiv und im Dateisystem miteinander</p></td><td><p>(<em>diff</em>)</p></td></tr><tr><td><p>-f</p></td><td><p>Schreibt ein Archiv in die angegebene Datei beziehungsweise liest die Daten aus der angegebenen Datei aus.</p></td><td><p>(<em>file</em>) Diese Option müssen Sie grundsätzlich als letzte eingeben, da alle nachfolgenden Eingaben als Dateien interpretiert werden.</p></td></tr><tr><td><p>-z</p></td><td><p>Komprimiert oder dekomprimiert das Archiv direkt mit gzip.</p></td><td><p>gzip muss bereits installiert sein.</p></td></tr><tr><td><p>-Z</p></td><td><p>Komprimiert oder dekomprimiert das Archiv direkt mit compress.</p></td><td><p>compress muss bereits installiert sein. Auf Großschreibung achten.</p></td></tr><tr><td><p>-j</p></td><td><p>Komprimiert oder dekomprimiert das Archiv direkt mit bzip2.</p></td><td><p>bzip2 muss bereits installiert sein.</p></td></tr><tr><td><p>-J</p></td><td><p>Komprimiert oder dekomprimiert das Archiv direkt mit xz.</p></td><td><p>xz muss bereits installiert sein. Auf Großschreibung achten.</p></td></tr><tr><td><p>-k</p></td><td><p>Verhindert, dass Dateien beim Extrahieren aus dem Archiv bereits existierende Dateien überschreiben.</p></td><td></td></tr><tr><td><p>-p</p></td><td><p>Behält die Zugriffsrechte beim Extrahieren bei.</p></td><td></td></tr><tr><td><p>-r</p></td><td><p>Fügt eine Datei zu einem bestehenden Archiv hinzu.</p></td><td><p>(<em>recreate</em>) Die Datei wird hinten angehängt. Funktioniert nur mit einem unkomprimierten Archiv.</p></td></tr><tr><td><p>-t</p></td><td><p>Zeigt den Inhalt eines Archivs an.</p></td><td><p>(<em>table</em>)</p></td></tr><tr><td><p>-u</p></td><td><p>Hängt nur Dateien an, die jünger sind als ihre jeweiligen Versionen im Archiv.</p></td><td></td></tr><tr><td><p>-v</p></td><td><p>Zeigt die Schritte bei der Archivierung an.</p></td><td><p>(<em>verbose</em>) </p></td></tr><tr><td><p>-vv</p></td><td><p>Zeigt detailliertere Informationen bei der Archivierung an.</p></td><td><p>(<em>very verbose</em>)</p></td></tr><tr><td><p>-w</p></td><td><p>Jede Aktion muss bestätigt werden.</p></td><td></td></tr><tr><td><p>-x</p></td><td><p>Extrahiert Dateien aus dem Archiv.</p></td><td><p>(<em>extract</em>) Die Dateien bleiben im Archiv enthalten.</p></td></tr><tr><td><p>-A</p></td><td><p>Hängt die Dateien eines bestehenden Archivs an ein anderes an.</p></td><td><p>Auf Großschreibung achten.</p></td></tr><tr><td><p>-C</p></td><td><p>Gibt den Ort an, in dem Dateien extrahiert werden sollen.</p></td><td><p>Auf Großschreibung achten.</p></td></tr><tr><td><p>-M</p></td><td><p>Erstellen, anzeigen oder extrahieren eines mehrteiligen Archivs.</p></td><td><p>Auf Großschreibung achten.</p></td></tr><tr><td><p>-L</p></td><td><p>Wechselt das Medium nach einer bestimmten Dateigröße.</p></td><td><p>Die Größe wird in Kilobytes angegeben. Auf Großschreibung achten.</p></td></tr><tr><td><p>-W</p></td><td><p>Überprüft das Archiv, nachdem es geschrieben wurde.</p></td><td><p>Auf Großschreibung achten.</p></td></tr><tr><td><p>-P</p></td><td><p>Archiviert alle Dateien vom Wurzelverzeichnis aus.</p></td><td><p>Auf Großschreibung achten.</p></td></tr><tr><td><p>--exclude</p></td><td><p>Schließt Dateien oder Ordner aus.</p></td><td><p>Wird nach dem Befehl zum Erstellen mit --exclude=&lt;Datei/Ordner&gt; angegeben.</p></td></tr><tr><td><p>-X</p></td><td><p>Liest eine Liste mit auszuschließenden Dateien.</p></td><td><p>Verlangt eine zuvor angelegte Liste: -X &lt;Liste&gt;.list. Auf Großschreibung achten.</p></td></tr><tr><td><p>-g</p></td><td><p>Erstellt ein Log aller Verzeichnisse inklusive Prüfsummen.</p></td><td></td></tr></table><p>Beim Erstellen von tar-Archiven haben Sie zudem die Möglichkeit, mit einem Sternchen Wildcards anzulegen. Wenn Sie ein neues Archiv erzeugen, geben Sie immer zuerst die Optionen an, dann den Dateinamen des Archivs, das Sie erstellen wollen, und schließlich die Dateien und Ordner, die enthalten sein sollen. In dem folgenden Beispiel erstellen Sie ein Archiv (<em>-c</em>) aus zwei Text-Dateien, komprimieren es mit gzip (<em>-z</em>) und schreiben es in die Datei archiv.tar.gz (<em>-f</em>):</p><p><em>	tar -czf archiv.tar.gz beispiel_1.txt beispiel_2.txt</em></p><p>Möchten Sie alle Textdateien im Verzeichnis zu einem Archiv zusammenfassen, verwenden Sie eine entsprechende Wildcard:</p><p><em>	tar -cf text_archiv.tar *.txt</em></p><p>Auch komplette Verzeichnisse und deren Unterverzeichnisse können Sie zu einem Archiv zusammenfassen. Im folgenden Beispiel wird <em>/verzeichnis1</em> inklusive aller Unterverzeichnisse und der enthaltenden Dateien ausschließlich des Unterverzeichnisses <em>/verzeichnis1/unterverzeichnis_x </em>archiviert:</p><p>	<em>tar -cf archiv.tar --exclude="/verzeichnis1/unterverzeichnis_x" /verzeichnis_1 </em></p><p>Im folgenden Beispiel extrahieren (<em>-x</em>) Sie das komprimierte (<em>-z</em>) Archiv, das wir im ersten Beispiel erstellt haben, in ein anderes Verzeichnis (<em>-C</em>):</p><p><em>	tar -xzf archiv.tar.gz -C /home/verzeichnis1/archiv_verzeichnis</em></p><p>Um einem Archiv (das dafür unkomprimiert sein muss) eine weitere Datei hinzuzufügen, geben Sie zum Beispiel folgenden Befehl ein:</p><p>	<em>tar -rf archiv.tar beispiel_extra.txt</em></p><h2>Wie funktioniert ein Backup mit tar?</h2><p>Webmaster verwenden tar gern, um Backups zu erstellen: Dabei bleibt die Verzeichnisstruktur erhalten und der Funktionsumfang des Programms lässt zusätzlich <strong>zahlreiche Feinabstimmungen</strong> zu, wie an den vielen Optionen ersichtlich ist. Im Folgenden erklären wir Ihnen, wie Sie ein vollständiges Backup mit tar erzeugen und wie Sie inkrementelle Backups mit dem Programm erstellen.</p><h3>Ein einfaches Backup mit tar erstellen</h3><p>Es ist sinnvoll für Ihre Sicherungsstrategie, wenn Sie ein Backup-Skript für die Archivierung Ihres Systems erstellen, statt einfach händisch Archive anzulegen. So können Sie <strong>automatisiert mehrere Verzeichnisse archivieren</strong>, komprimieren und auf einen externen Datenspeicher übertragen. Wichtig dafür ist, dass Sie durchgehend schreib- und leseberechtigt in den entsprechenden Verzeichnissen sind. Zunächst legen Sie in Ihrem Home-Verzeichnis ein Verzeichnis <em>bin </em>an (falls Sie ein solches noch nicht haben) und erstellen dort das Skript. Das folgende Beispielskript müssen Sie selbstverständlich an Ihre Bedürfnisse und Verzeichnisstruktur anpassen:</p><p><em>	#!/bin/bash</em></p><p><em>	DATE=$(date +%Y-%m-%d-%H%M%S)</em></p><p><em>	BACKUP_DIR="/zielverzeichnis/backup"</em></p><p><em>	SOURCE="$HOME/quellverzeichnis"</em></p><p><em>	tar -cvzpf $BACKUP_DIR/backup-$DATE.tar.gz $SOURCE</em></p><p>Damit Sie verstehen, was genau dieses Skript bewirkt, erklären wir es nun Zeile für Zeile:</p><ol><li>Die erste Zeile ist der sogenannte Shebang, der dem Betriebssystem mitteilt, welches Interpreter-Programm es verwenden soll. In diesem Fall wird bash verwendet.</li><li>Jedes Backup mit tar erhält einen Zeitstempel. Das ist wichtig, damit mehrere Backups sicher auseinandergehalten werden können. Der Variablen gibt man beispielsweise folgendes Format: Jahr-Monat-Tag-StundeMinuteSekunde, also zum Beispiel 2017-09-07-152833.</li><li>Hiermit bestimmen Sie das Verzeichnis, in dem das Backup erstellt wird. Das letzte Unterverzeichnis beenden Sie nicht mit „/“.</li><li>In dieser Zeile legen Sie fest, welche Verzeichnisse Sie in das Archiv aufnehmen möchten. Hier kann man auch mehrere Verzeichnisse aufführen, die nur von einem Leerzeichen getrennt werden: SOURCE="$HOME/quellverzeichnis1 $HOME/quellverzeichnis2 ". An dieser Stelle notieren Sie ebenfalls kein „/“ am Ende der Verzeichnisse. Achten Sie in jedem Fall darauf, ein Leerzeichen vor dem abschließenden Anführungszeichen einzufügen.</li><li>Die letzte Zeile des Skripts enthält schließlich den tar-Befehl:<ul><li><em>-cvzpf</em> erstellt ein Archiv (<em>-c</em>), die Schritte dabei werden angezeigt (<em>-v</em>), es wird mit gzip komprimiert (<em>-z</em>), die Zugriffsrechte werden beibehalten (<em>-p</em>) und alles wird in folgende Datei ausgegeben (<em>-f</em>). Vor allem <em>-v</em> und <em>-p</em> sind dabei optional und Sie haben zudem die Möglichkeit, weitere Optionen einzufügen, um Ihr Backup anders zu gestalten.</li><li><em>$BACKUP_DIR/backup-$DATE.tar.gz</em> benennt das Verzeichnis (<em>$BACKUP_DIR</em>) und die Datei, in die das Backup gespeichert werden soll. In unserem Beispiel nennen wir diese <em>backup</em>, gefolgt vom aktuellen Zeitstempel. Abgeschlossen wird der Dateiname mit der Angabe des Formats, in dem man die Datei erstellt. Wenn Sie eine andere Komprimierung verwenden möchten, müssen Sie daran denken, sowohl das Dateiformat als auch die Option im Befehl zu ändern.</li><li>Zum Schluss teilen Sie tar durch die Variable <em>$SOURCE</em> mit, was es überhaupt archivieren soll. Denkbar ist es, dass Sie zusätzlich mit <em>--exclude</em> oder <em>-X</em> Verzeichnisse oder Dateien ausschließen, die nicht in das Backup aufgenommen werden sollen.</li></ul></li></ol><p>[Tipp: Prinzipiell spielt es bei Linux und Unix keine Rolle, welche Endung Sie der Skript-Datei geben. Die Systeme lesen die Art der Datei aus, indem sie die Dateistruktur mit einem Magic-File vergleichen. Dabei handelt es sich um eine Datenbank, die sich für gewöhnlich unter <em>/etc/magic </em>finden lässt. Dennoch hat es sich eingebürgert, Dateiendungen anzugeben, damit Sie als Nutzer leichter den Überblick behalten.]</p><p>Nun speichern Sie die Datei mit dem Namen <em>backup</em> im <em>bin</em>-Verzeichnis und fügen dessen Pfad der PATH-Variable hinzu:</p><p>	<em>PATH=$PATH:$HOME/bin</em></p><p>Das soeben erstellte Backup-Skript müssen Sie noch ausführbar machen:</p><p><em>	chmod u+x $HOME/bin/backup</em></p><p>Damit machen Sie die Datei nur für Sie selbst (<em>u</em>) ausführbar. Sie können die Rechte aber auch an eine Gruppe (<em>g</em>), an andere (<em>o</em>) oder an alle (<em>a</em>) vergeben. Jetzt sind Sie fertig und können das Skript ausführen:</p><p><em>	sudo backup</em></p><p>Wenn Sie das Backup wieder herstellen möchten, also das Archiv extrahieren, dann reicht hierfür ein Befehl:</p><p><em>	tar -xzf backup.tar.gz -C /</em></p><p>Das Skript erstellt ein Voll-Backup. Dies ist aber gerade bei der Sicherung eines kompletten Servers nicht immer die richtige Wahl. Deshalb sollten Sie überlegen, ob ein inkrementelles Backup mit tar für Ihre Zwecke nicht sinnvoller ist.</p><p>[Hinweis: Beim Erstellen eines Archivs mit absoluten Pfadangaben liefert tar die Meldung: „tar: Entferne führende „/“ von Elementnamen“. Dies ist keine Fehlermeldung, sondern ein Hinweis auf eine Sicherheitsvorkehrung beim Zurückspielen: tar macht aus <em>/home/unterverzeichnis</em> den Pfad <em>home/unterverzeichnis</em>. Wenn Sie sich beim Extrahieren des Archivs nun nicht im Root-Verzeichnis befinden, legt tar eine neue Verzeichnisstruktur an, zum Beispiel: <em>/home/unterverzeichnis/home/unterverzeichnis</em>. Damit ist die Wahrscheinlichkeit, dass Sie versehentlich Ihr komplettes System überschreiben, verringert. Denken Sie daran: Unix fragt beim Überschreiben nicht nach. Sie müssen also, sollten Sie bestehende Inhalte wirklich ersetzen wollen, zuerst ins Root-Verzeichnis navigieren. Umgehen können Sie dies durch die Option <em>-P</em>] </p><h3>Was ist ein inkrementelles Backup?</h3><p>Webmaster erstellen <strong>regelmäßig Backups, um einen Datenverlust zu vermeiden</strong>. Sollte das eigentliche System seinen Dienst verweigern, kompromittiert oder gelöscht worden sein, kann man in solch einem Fall eine funktionierende Version aus dem Backup aufspielen. Je häufiger Sie Speicherpunkte setzen, umso weniger Datenverlust müssen Sie im Notfall hinnehmen. Wenn Sie nun jedes Mal ein vollständiges Backup speichern, also alle Daten des System archivieren, dauert das zum einen sehr lang und zum anderen ist ein großer Speicherbedarf notwendig. Stattdessen können Sie auf inkrementelle Backups setzen.</p><p>Ein inkrementelles Backup setzt immer eine Vollspeicherung voraus. Sie müssen das System (oder zumindest den Teil, den Sie sichern möchten) zuerst einmal komplett archivieren. Im Anschluss werden bei einem inkrementellen Backup nur noch <strong>neue oder veränderte Dateien</strong> gesichert. Dies führt zu einem sehr viel kleineren Datenaufkommen, verlangt bei einer Wiederherstellung aber einen größeren Aufwand. Wenn Sie das Backup also wieder aufspielen, benötigen Sie das letzte Voll-Backup und jedes inkrementelle Backup, das Sie seit jener vollständigen Archivierung erstellt haben. Sollte Ihnen eine Datei davon verloren gegangen sein (das ist heutzutage unwahrscheinlicher als noch zu Zeiten von Magnetbändern), ist das Backup lückenhaft.</p><h3>Ein inkrementelles Backup mit tar erstellen</h3><p>Mit tar lassen sich <strong>regelmäßige inkrementelle Backups</strong> erstellen. Auch hierfür schreiben Sie ein eigenes Backup-Skript. Damit können Sie zum Beispiel festlegen, dass einmal pro Monat ein Voll-Backup erstellt wird und dann täglich ein inkrementelles Backup. Außerdem erreicht man mit dem folgenden Skript, dass alte Backups regelmäßig in nach Datum sortierte Ordner verschoben werden. Zusätzlich zu tar benötigen Sie hierfür auch noch cron. Dieser Daemon (ein Programm, das im Hintergrund läuft) lässt zeitbasierte Ausführungen von anderen Prozessen zu – cron ist bei Ubuntu grundsätzlich enthalten. Zunächst öffnen Sie also wieder einen Texteditor und erstellen Ihr Skript:</p><p><em>#!/bin/bash</em></p><p><em>BACKUP_DIR="/zielverzeichnis/backup"</em></p><p><em>ROTATE_DIR="/zielverzeichnis/backup/rotate"</em></p><p><em>TIMESTAMP="timestamp.dat"</em></p><p><em>SOURCE="$HOME/quellverzeichnis "</em></p><p><em>DATE=$(date +%Y-%m-%d-%H%M%S)</em></p><p><em>EXCLUDE="--exclude=/mnt/* --exclude=/proc/* --exclude=/sys/* --exclude=/tmp/*"</em></p><p><em>cd /</em></p><p><em>mkdir -p ${BACKUP_DIR}</em></p><p><em>set -- ${BACKUP_DIR}/backup-??.tar.gz</em></p><p><em>lastname=${!#}</em></p><p><em>backupnr=${lastname##*backup-}</em></p><p><em>backupnr=${backupnr%%.*}</em></p><p><em>backupnr=${backupnr//\?/0}</em></p><p><em>backupnr=$[10#${backupnr}]</em></p><p><em>if [ "$[backupnr++]" -ge 30 ]; then</em></p><p><em>mkdir -p ${ROTATE_DIR}/${DATE}</em></p><p><em>mv ${BACKUP_DIR}/b* ${ROTATE_DIR}/${DATE}</em></p><p><em>mv ${BACKUP_DIR}/t* ${ROTATE_DIR}/${DATE}</em></p><p><em>backupnr=1</em></p><p><em>fi</em></p><p><em>backupnr=0${backupnr}</em></p><p><em>backupnr=${backupnr: -2}</em></p><p><em>filename=backup-${backupnr}.tar.gz</em></p><p><em>tar -cpzf ${BACKUP_DIR}/${filename} -g ${BACKUP_DIR}/${TIMESTAMP} -X $EXCLUDE ${SOURCE]</em></p><p>Auch für dieses Backup-Skript erklären wir Ihnen Schritt für Schritt, was passiert:</p><ul><li>Zunächst definieren Sie wieder den Interpreter.</li><li>Anschließend legen Sie die Variablen fest. Neu hinzugekommen sind ein Verzeichnis für Rotationen der Backups (eine Art Archiv der Backups) und eine Datei für einen Timestamp.</li><li>In unserem Beispiel illustrieren wir, dass es nicht immer sinnvoll ist, alle Verzeichnisse in das Backup zu übernehmen. Ausgeschlossen haben wir in diesem Fall die Inhalte der Ordner (und nicht die Ordner selbst, daher das „*“) <em>mnt</em>, <em>proc</em>, <em>sys</em> und <em>tmp</em>. Denn die Daten in diesen Verzeichnissen sind temporär oder werden bei jedem Systemstart neu erstellt.</li><li>Damit die Pfade alle richtig interpretiert werden, wechselt das Skript mit <em>cd /</em> in das Root-Verzeichnis.</li><li>Mit <em>mkdir</em> legen Sie das Backup-Verzeichnis an, falls es noch nicht existiert.</li><li>Nun werden alle Variablen eingelesen. Da Sie Ihre Backups durchnummerieren wollen, ermittelt der Code-Block die Nummer des letzten Backups. Dies geschieht, indem das Skript die anderen Bestandteile des Dateinamens entfernt.</li><li>Sie nehmen immer nur 30 Backups auf, danach verschiebt das Skript alle Archivdateien in den Rotationsordner. Dieser wird zuerst erstellt und dann werden mit <em>mv</em> alle Dateien, die mit den Buchstaben <em>b</em> und <em>t</em> beginnen, in den neuen Ordner verschoben. Die Beschränkung der Buchstaben erklärt sich dadurch, dass ohnehin nur damit gekennzeichnete Dateien in dem Ordner sein sollten: nämlich <em>backup</em> und <em>timestamp</em>. Schließlich setzt das Skript die Backup-Nummer wieder auf 1. Stellt Ihr Skript fest, dass noch keine 30 Backups erstellt wurden, erhöht es die Dateinummer einfach um 1 (<em>++</em>).</li><li>Jetzt macht das Skript quasi wieder das rückgängig, was es am Anfang vorgenommen hat: Die Befehle sorgen dafür, dass der Dateiname wieder – jetzt mit der neuen Nummer – vollständig ist.</li><li>Schließlich führt das Skript den eigentlichen tar-Befehl aus: Im Vergleich zum Kommando des einfachen Voll-Backups ist hier eine weitere Option hinzugekommen. Mit -g wird das inkrementelle Backup ermöglicht. Dazu liest tar den Timestamp jeder Datei aus, gleicht diesen mit den bislang in timestamp.dat aufgezeichneten Daten ab und kann so entscheiden, welche Änderungen seit dem letzten Backup entstanden sind. Nur diese werden Teil des neuen Archivs.</li></ul><p>[Hinweis: Das Skript verschiebt (bei täglicher Archivierung) jeden Monat die Backup-Dateien in einen neuen Archivordner, damit das eigentliche Backupverzeichnis nur die aktuellsten Daten enthält. Es ist allerdings keine Funktion eingebaut, die die Anzahl der Archivordner begrenzt. Das bedeutet, dass Sie diese manuell löschen müssen.]</p><p>Damit ist das Skript zum Erstellen eines inkrementellen Backups mit tar fertig: Speichern Sie die Datei als <em>backup</em> im <em>bin</em>-Verzeichnis. Auch hier müssen Sie den Pfad exportieren und das Skript ausführbar machen:</p><p><em>PATH=$PATH:$HOME/bin</em></p><p><em>	chmod u+x $HOME/bin/backup</em></p><p>Theoretisch können Sie jetzt Ihr Backup-Skript mit <em>sudo backup</em> starten. Die Idee hinter dem inkrementellen Backup ist aber ja, dass der Vorgang <strong>automatisiert und täglich</strong> durchgeführt wird. Dafür greift man zu cron und ändert die sogenannte Crontab. Dies ist die Tabelle, nach der cron Aufgaben ausführt. Sie hat sechs Felder:</p><table><tr><td><p>Minuten</p><p>(0-59)</p></td><td><p>Stunden</p><p>(0-23)</p></td><td><p>Tage</p><p>(1-31)</p></td><td><p>Monate</p><p>(1-12)</p></td><td><p>Wochentage</p><p>(0-7)</p></td><td><p>Auftrag</p></td></tr></table><p>In die Felder können Sie entweder Zahlen entsprechend des Wertebereichs (in Klammern angegeben) oder einen Asterisk (*) eingeben. Letzterer bedeutet so viel wie: zu jedem möglichen Wert. Eine Besonderheit stellt die Spalte Wochentag dar. Hiermit können Sie festlegen, dass ein Auftrag zum Beispiel jeden Montag (1) oder nur an Werktagen (1–5) ausgeführt wird. Den Sonntag kann man durch zwei unterschiedliche Werte angeben: Sowohl 0 als auch 7 beziehen sich auf Sonntag, da für einige Menschen die Woche mit diesem Tag beginnt und für andere damit endet.</p><p>In der Kommandozeile öffnen Sie den Editormodus von cron mit:</p><p><em>	sudo crontab –e</em></p><p>Hier fügen Sie folgende Zeile ein:</p><p>	<em>30 7 * * * /home/bin/backup</em></p><p>Damit haben wir veranlasst, dass das Backup jeden Tag (und jeden Monat, unabhängig vom Wochentag) um 7.30 Uhr morgens ausgeführt wird. Speichern Sie Ihre Änderungen ab und Ihr tägliches inkrementelles Backup ist einsatzbereit.</p><p>[Hinweis: cron funktioniert nur dann, wenn Ihr System läuft. Bei Webservern sollte das ohnehin der Fall sein. Wenn Sie aber planen, das Skript für die Sicherung Ihres PC oder Laptops einzusetzen, müssten Sie garantieren, dass die Geräte auch jeden Tag um 7.30 Uhr laufen. Ist das Gerät nicht eingeschaltet, fällt das Backup einfach aus. Eine Möglichkeit, dies zu umgehen, bietet anacron. Dieses Programm verschiebt bei einem nicht laufenden System die geplante Ausführung auf einen Moment, in dem das Gerät wieder aktiv ist.]</p><h3>System aus einem Backup wiederherstellen</h3><p>Man möchte es niemandem wünschen, aber der Ernstfall kann eintreten und Ihr System muss wiederhergestellt werden. Mit tar geht auch das relativ leicht und benötigt zudem kein zusätzliches Skript. Ein einzelner Befehl wie bei einem einfachen Voll-Backup ist aber nicht möglich: Es liegt in der Natur des inkrementellen Backups, dass mehrere Dateien entpackt werden müssen. In die Konsole geben Sie diese Befehlszeilen ein:</p><p><em>	BACKUP_DIR=/zielverzeichnis/backup</em></p><p><em>cd /</em></p><p><em>	for archiv in ${BACKUP_DIR}/backup-*.tar.gz; do</em></p><p><em>	tar -xpzf $archiv -C /</em></p><p><em>	done</em></p><p>[Hinweis: Bei Wiederherstellung des Systems aus dem Backup werden alle Verzeichnisse und damit eventuell auch wichtige Dateien überschrieben.]</p><p>Damit Sie nicht jede Archivdatei einzeln extrahieren müssen, verwenden Sie eine for-Schleife:</p><ol><li>Im ersten Schritt definieren Sie das Verzeichnis, in dem die Backups liegen.</li><li>Mit <em>cd /</em> wechseln Sie in das Rootverzeichnis, damit sichergestellt ist, dass das Archiv auch am korrekten Platz extrahiert wird.</li><li>Nun starten Sie eine for-Schleife: Dieser Befehl wiederholt alle Aktionen, die zwischen <em>do</em> und <em>done</em> stehen, bis alle Möglichkeiten durchlaufen sind. Zur Spezifikation des Befehls geben Sie den Pfad Ihrer Backups wieder mit einem Asterisk als Wildcard an, denn Sie möchten alle Archivdateien in diesem Verzeichnis entpacken.</li><li>Den tar-Befehl spezifiziert man folgendermaßen: Sie extrahieren (<em>-x</em>), bei Beibehaltung der Zugriffsrechte (<em>-p</em>), und dekomprimieren (<em>-z</em>) das Archiv (-<em>f $archiv</em>) in das Wurzelverzeichnis (<em>-C /</em>).</li><li>Mit <em>done</em> legen Sie den Endpunkt der Schleife fest.</li></ol><p>Da Sie beim Erstellen der Archive diese durchnummeriert haben, werden die Backups nacheinander wieder aufgespielt – und zwar beginnend mit dem ältesten. Das ist wichtig: In den Archiven, die nach dem Voll-Backup entstanden sind, befinden sich jeweils neuere Versionen von Dateien. Das bedeutet, dass während der Schleife zunächst die alte Version extrahiert wird, um dann, beim nächsten Durchlauf, mit einer neueren Fassung überschrieben zu werden. Am Ende haben Sie <strong>das komplette System mit dem Backup überschrieben</strong> und die neuste, archivierte Version jeder einzelnen Datei wiederhergestellt.</p><p>Dies ist der eigentliche Sinn, eines inkrementellen Backups: die komplette Wiederherstellung des Systems. Mit einem kleinen Umweg ist es aber sogar möglich, <strong>nur eine einzelne Datei zu retten</strong> und die zuvor archivierte, letzte Version zurückzuholen. Dafür gehen Sie in zwei Schritten vor:</p><p><em>	BACKUP_DIR=/zielverzeichnis/backup</em></p><p><em>	ls -l ${BACKUP_DIR}</em></p><p><em>	for archiv in ${BACKUP_DIR}/backup-*tar.gz; do</em></p><p><em>	tar -tzf $archiv | grep gesuchte-datei;</em></p><p><em>	done</em></p><p>Auch in diesem ersten Schritt greifen Sie auf eine for-Schleife zurück, die allerdings zum Suchen und nicht zum Extrahieren verwendet wird:</p><ol><li>Sie definieren erneut Ihr Backup-Verzeichnis.</li><li>Mit dem Kommando ls lassen Sie sich alle Dateien und Ordner im Backup-Verzeichnis anzeigen. Die Option -l ermöglicht detaillierte Informationen.</li><li>Sie eröffnen eine Schleife wie beim Wiederherstellen des kompletten Archivs.</li><li>Die wichtige Änderung ist in den Optionen des tar-Befehls zu finden: Statt ein Archiv zu erstellen (<em>c</em>) oder zu extrahieren (<em>x</em>), lassen Sie den Inhalt der Archive anzeigen (<em>t</em>). Da aber nicht Sie selbst nach der Datei suchen wollen, leiten Sie die Ausgabe mit einem Pipe (senkrechter Strich) an den Befehl <em>grep</em> weiter. Dieser sucht innerhalb der Ausgabe (also dem Inhalt der Archive) nach der Datei, die Sie suchen. </li><li>Beenden Sie die Schleife.</li></ol><p>Nun zeigt Ihnen das Terminal die gesuchte Datei an – und vielleicht sogar mehrfach, wenn Sie diese regelmäßig bearbeitet haben und sie daher in jedem inkrementellen Backup auftaucht. Merken Sie sich nun den Pfad zu der Datei und bauen Sie eine weitere Schleife, die dann die letzte gespeicherte Version wiederherstellt:</p><p><em>	for archiv in ${BACKUP_DIR}/backup-*.tar.gz; do</em></p><p><em>	tar –xzf $archiv -C / zielverzeichnis/backup/gesuchte-datei</em></p><p><em>	done</em></p><p>Nun wird die Datei an ihrem ursprünglichen Ort wiederhergestellt und überschreibt dabei auch eine mögliche aktuellere Version.</p></body></html>